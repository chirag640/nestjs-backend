import { z } from 'zod';

export const EnvSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  PORT: z.string().regex(/^\d+$/).transform(Number).default('3000'),
  
{% if orm == 'mongoose' %}
  // MongoDB Configuration
  DATABASE_URL: z.string().min(1, 'DATABASE_URL is required'),
{% elif orm == 'typeorm' %}
  // Database Configuration
  DB_HOST: z.string().min(1, 'DB_HOST is required'),
  DB_PORT: z.string().regex(/^\d+$/).transform(Number),
  DB_USERNAME: z.string().min(1, 'DB_USERNAME is required'),
  DB_PASSWORD: z.string().min(1, 'DB_PASSWORD is required'),
  DB_DATABASE: z.string().min(1, 'DB_DATABASE is required'),
{% elif orm == 'prisma' %}
  // Prisma Database URL
  DATABASE_URL: z.string().url('Invalid DATABASE_URL'),
{% endif %}

{% if auth and auth.enabled and auth.jwt %}
  // JWT Configuration
  JWT_SECRET: z.string().min(32, 'JWT_SECRET must be at least 32 characters'),
  JWT_ACCESS_EXPIRY: z.string().default('{{ auth.jwt.accessTTL }}'),
  JWT_REFRESH_SECRET: z.string().min(32, 'JWT_REFRESH_SECRET must be at least 32 characters'),
  JWT_REFRESH_EXPIRY: z.string().default('{{ auth.jwt.refreshTTL }}'),
{% endif %}

{% if oauth and oauth.enabled %}
  {% for provider in oauth.providers %}
    {% if provider.name == 'google' %}
  // Google OAuth Configuration
  GOOGLE_CLIENT_ID: z.string().min(1, 'GOOGLE_CLIENT_ID is required'),
  GOOGLE_CLIENT_SECRET: z.string().min(1, 'GOOGLE_CLIENT_SECRET is required'),
  GOOGLE_CALLBACK_URL: z.string().url('Invalid GOOGLE_CALLBACK_URL'),
    {% endif %}
    {% if provider.name == 'github' %}
  // GitHub OAuth Configuration
  GITHUB_CLIENT_ID: z.string().min(1, 'GITHUB_CLIENT_ID is required'),
  GITHUB_CLIENT_SECRET: z.string().min(1, 'GITHUB_CLIENT_SECRET is required'),
  GITHUB_CALLBACK_URL: z.string().url('Invalid GITHUB_CALLBACK_URL'),
    {% endif %}
  {% endfor %}
{% endif %}

{% if features.caching %}
  // Redis Configuration
  // Format: redis://[username:password@]host:port[/database]
  // Example: redis://localhost:6379 or redis://user:pass@redis-host:6379/0
  REDIS_URL: z.string().url().default('redis://localhost:6379'),
{% endif %}

  // CORS Configuration
  ALLOWED_ORIGINS: z.string().transform((val) => val.split(',')).default('http://localhost:3000'),

{% if features.health %}
  // Health Check Configuration
  DISK_CHECK_PATH: z.string().default('/'),
{% endif %}
});

export type EnvConfig = z.infer<typeof EnvSchema>;

export function validateEnv(): EnvConfig {
  try {
    return EnvSchema.parse(process.env);
  } catch (error) {
    if (error instanceof z.ZodError) {
      const messages = error.errors.map((err) => {
        const path = err.path.join('.');
        return `  âŒ ${path}: ${err.message}`;
      }).join('\n');
      
      console.error('\nğŸš¨ Environment validation failed:\n');
      console.error(messages);
      console.error('\nğŸ“ Please check your .env file and ensure all required variables are set.\n');
      console.error('ğŸ’¡ See .env.example for reference.\n');
      
      process.exit(1);
    }
    throw error;
  }
}
