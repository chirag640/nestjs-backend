import { z } from 'zod';

export const EnvSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  PORT: z.string().regex(/^\d+$/).transform(Number).default('3000'),
  
{% if orm == 'mongoose' %}
  // MongoDB Configuration
  DATABASE_URL: z.string().min(1, 'DATABASE_URL is required'),
{% elif orm == 'typeorm' %}
  // Database Configuration
  DB_HOST: z.string().min(1, 'DB_HOST is required'),
  DB_PORT: z.string().regex(/^\d+$/).transform(Number),
  DB_USERNAME: z.string().min(1, 'DB_USERNAME is required'),
  DB_PASSWORD: z.string().min(1, 'DB_PASSWORD is required'),
  DB_DATABASE: z.string().min(1, 'DB_DATABASE is required'),
{% elif orm == 'prisma' %}
  // Prisma Database URL
  DATABASE_URL: z.string().url('Invalid DATABASE_URL'),
{% endif %}

{% if auth and auth.enabled and auth.jwt %}
  // JWT Configuration
  JWT_SECRET: z.string().min(32, 'JWT_SECRET must be at least 32 characters'),
  JWT_ACCESS_EXPIRY: z.string().default('{{ auth.jwt.accessTTL }}'),
  JWT_REFRESH_SECRET: z.string().min(32, 'JWT_REFRESH_SECRET must be at least 32 characters'),
  JWT_REFRESH_EXPIRY: z.string().default('{{ auth.jwt.refreshTTL }}'),
{% endif %}

{% if oauth and oauth.enabled %}
  {% for provider in oauth.providers %}
    {% if provider.name == 'google' %}
  // Google OAuth Configuration
  GOOGLE_CLIENT_ID: z.string().min(1, 'GOOGLE_CLIENT_ID is required'),
  GOOGLE_CLIENT_SECRET: z.string().min(1, 'GOOGLE_CLIENT_SECRET is required'),
  GOOGLE_CALLBACK_URL: z.string().url('Invalid GOOGLE_CALLBACK_URL'),
    {% endif %}
    {% if provider.name == 'github' %}
  // GitHub OAuth Configuration
  GITHUB_CLIENT_ID: z.string().min(1, 'GITHUB_CLIENT_ID is required'),
  GITHUB_CLIENT_SECRET: z.string().min(1, 'GITHUB_CLIENT_SECRET is required'),
  GITHUB_CALLBACK_URL: z.string().url('Invalid GITHUB_CALLBACK_URL'),
    {% endif %}
  {% endfor %}
{% endif %}

{% if features.caching %}
  // Redis Configuration
  // Format: redis://[username:password@]host:port[/database]
  // Example: redis://localhost:6379 or redis://user:pass@redis-host:6379/0
  REDIS_URL: z.string().url().default('redis://localhost:6379'),
{% endif %}

  // CORS Configuration
  ALLOWED_ORIGINS: z.string().transform((val) => val.split(',')).default('http://localhost:3000'),

{% if features.rateLimit %}
  // Rate Limiting Configuration
  THROTTLE_TTL: z.string().optional().default('60000').transform((val) => parseInt(val, 10)),
  THROTTLE_LIMIT: z.string().optional().default('10').transform((val) => parseInt(val, 10)),
{% endif %}

  // Request Configuration
  REQUEST_BODY_LIMIT: z.string().optional().default('1mb'),
  REQUEST_TIMEOUT: z.string().optional().default('30000').transform((val) => parseInt(val, 10)),

  // Security
  CSRF_SECRET: z.string().optional(),

  // Documentation
  ENABLE_SWAGGER: z.string().optional().default('true').transform((val) => val === 'true'),

{% if features.health %}
  // Health Check Configuration
  DISK_CHECK_PATH: z.string().default('/'),
{% endif %}

{% if features.encryption %}
  // Encryption Configuration
  ENCRYPTION_STRATEGY: z.enum(['disabled', 'local', 'aws_kms']).default('disabled'),
  // Local encryption settings (required when ENCRYPTION_STRATEGY=local)
  ENCRYPTION_MASTER_KEY: z.string().optional(),
  // AWS KMS settings (required when ENCRYPTION_STRATEGY=aws_kms)
  KMS_KEY_ID: z.string().optional(),
  AWS_REGION: z.string().optional(),
{% endif %}
}){% if features.encryption %}.superRefine((data, ctx) => {
  // Validate encryption strategy requirements
  if (data.ENCRYPTION_STRATEGY === 'local' && !data.ENCRYPTION_MASTER_KEY) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      path: ['ENCRYPTION_MASTER_KEY'],
      message: 'ENCRYPTION_MASTER_KEY is required when ENCRYPTION_STRATEGY=local. Must be 64 hex characters (32 bytes).',
    });
  }
  
  if (data.ENCRYPTION_STRATEGY === 'local' && data.ENCRYPTION_MASTER_KEY && !/^[0-9a-fA-F]{64}$/.test(data.ENCRYPTION_MASTER_KEY)) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      path: ['ENCRYPTION_MASTER_KEY'],
      message: 'ENCRYPTION_MASTER_KEY must be exactly 64 hexadecimal characters (32 bytes).',
    });
  }
  
  if (data.ENCRYPTION_STRATEGY === 'aws_kms' && !data.KMS_KEY_ID) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      path: ['KMS_KEY_ID'],
      message: 'KMS_KEY_ID is required when ENCRYPTION_STRATEGY=aws_kms. Should be ARN or key ID.',
    });
  }
  
  if (data.ENCRYPTION_STRATEGY === 'aws_kms' && !data.AWS_REGION) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      path: ['AWS_REGION'],
      message: 'AWS_REGION is required when ENCRYPTION_STRATEGY=aws_kms.',
    });
  }
}){% endif %};

export type EnvConfig = z.infer<typeof EnvSchema>;

export function validateEnv(): EnvConfig {
  try {
    return EnvSchema.parse(process.env);
  } catch (error) {
    if (error instanceof z.ZodError) {
      const messages = error.errors.map((err) => {
        const path = err.path.join('.');
        return `  ‚ùå ${path}: ${err.message}`;
      }).join('\n');
      
      console.error('\nüö® Environment validation failed:\n');
      console.error(messages);
      console.error('\nüìù Please check your .env file and ensure all required variables are set.\n');
      console.error('üí° See .env.example for reference.\n');
      
      process.exit(1);
    }
    throw error;
  }
}
