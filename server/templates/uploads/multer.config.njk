import { diskStorage } from 'multer';
import { ConfigService } from '@nestjs/config';
import { Request } from 'express';
import { extname } from 'path';
import { BadRequestException } from '@nestjs/common';
import { v4 as uuidv4 } from 'uuid';

/**
 * Multer configuration factory
 */
export const multerConfig = (configService: ConfigService) => {
  const maxFileSize = configService.get('MAX_FILE_SIZE', 10 * 1024 * 1024); // 10MB default
  const uploadDir = configService.get('UPLOAD_DIR', './uploads');

  return {
    storage: diskStorage({
      destination: (req: Request, file: Express.Multer.File, cb) => {
        cb(null, uploadDir);
      },
      filename: (req: Request, file: Express.Multer.File, cb) => {
        // Generate unique filename: uuid-timestamp.ext
        const uniqueId = uuidv4();
        const timestamp = Date.now();
        const ext = extname(file.originalname).toLowerCase();
        const filename = `${uniqueId}-${timestamp}${ext}`;
        cb(null, filename);
      },
    }),
    limits: {
      fileSize: maxFileSize,
      files: 10, // Max 10 files per request
    },
    fileFilter: (req: Request, file: Express.Multer.File, cb) => {
      // Validate file type
      if (!isAllowedMimeType(file.mimetype)) {
        return cb(
          new BadRequestException(`File type ${file.mimetype} is not allowed`),
          false,
        );
      }
      cb(null, true);
    },
  };
};

/**
 * Allowed MIME types
 */
const ALLOWED_MIME_TYPES = new Set([
  // Images
  'image/jpeg',
  'image/png',
  'image/gif',
  'image/webp',
  'image/svg+xml',
  // Documents
  'application/pdf',
  'application/msword',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'application/vnd.ms-excel',
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  // Text
  'text/plain',
  'text/csv',
  // Archives
  'application/zip',
  'application/x-rar-compressed',
]);

function isAllowedMimeType(mimeType: string): boolean {
  return ALLOWED_MIME_TYPES.has(mimeType);
}

/**
 * Image-only Multer filter
 */
export const imageFileFilter = (req: Request, file: Express.Multer.File, cb) => {
  if (!file.mimetype.startsWith('image/')) {
    return cb(new BadRequestException('Only image files are allowed'), false);
  }
  cb(null, true);
};

/**
 * Document-only Multer filter
 */
export const documentFileFilter = (req: Request, file: Express.Multer.File, cb) => {
  const docTypes = [
    'application/pdf',
    'application/msword',
    'application/vnd.openxmlformats-officedocument',
    'text/plain',
    'text/csv',
  ];
  
  if (!docTypes.some((type) => file.mimetype.includes(type))) {
    return cb(new BadRequestException('Only document files are allowed'), false);
  }
  cb(null, true);
};
