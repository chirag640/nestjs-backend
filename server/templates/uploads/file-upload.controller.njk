import { Controller, Post, UseInterceptors, UploadedFile, UploadedFiles, Body, Get, Param, Delete } from '@nestjs/common';
import { FileInterceptor, FilesInterceptor } from '@nestjs/platform-express';
import { ApiTags, ApiOperation, ApiConsumes, ApiBody, ApiBearerAuth, ApiResponse } from '@nestjs/swagger';
import { FileUploadService, UploadedFile as UploadResult, ImageResizeOptions } from './file-upload.service';
import { imageFileFilter } from './multer.config';

/**
 * File Upload Controller
 */
@ApiTags('Files')
@ApiBearerAuth()
@Controller('files')
export class FileUploadController {
  constructor(private readonly fileUploadService: FileUploadService) {}

  /**
   * Upload single file
   */
  @Post('upload')
  @UseInterceptors(FileInterceptor('file'))
  @ApiConsumes('multipart/form-data')
  @ApiOperation({ summary: 'Upload a single file' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        file: { type: 'string', format: 'binary' },
      },
    },
  })
  async uploadFile(@UploadedFile() file: Express.Multer.File): Promise<UploadResult> {
    return this.fileUploadService.uploadFile(file);
  }

  /**
   * Upload multiple files
   */
  @Post('upload/multiple')
  @UseInterceptors(FilesInterceptor('files', 10))
  @ApiConsumes('multipart/form-data')
  @ApiOperation({ summary: 'Upload multiple files (max 10)' })
  async uploadFiles(@UploadedFiles() files: Express.Multer.File[]): Promise<UploadResult[]> {
    return this.fileUploadService.uploadFiles(files);
  }

  /**
   * Upload and resize image
   */
  @Post('upload/image')
  @UseInterceptors(FileInterceptor('file', { fileFilter: imageFileFilter }))
  @ApiConsumes('multipart/form-data')
  @ApiOperation({ summary: 'Upload and process image' })
  async uploadImage(
    @UploadedFile() file: Express.Multer.File,
    @Body() options: ImageResizeOptions,
  ): Promise<UploadResult> {
    return this.fileUploadService.uploadImage(file, options);
  }

  /**
   * Delete a file
   */
  @Delete(':path')
  @ApiOperation({ summary: 'Delete a file' })
  async deleteFile(@Param('path') path: string): Promise<{ success: boolean }> {
    await this.fileUploadService.deleteFile(path);
    return { success: true };
  }
}
