import { Injectable, Logger, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

export interface TranslationContext {
  locale: string;
  fallbackLocale: string;
  translations: Record<string, Record<string, string>>;
}

/**
 * Internationalization (i18n) Service
 * 
 * Features:
 * - Multi-language support
 * - Locale detection (header, query, cookie)
 * - Date/Time formatting
 * - Number/Currency formatting
 * - Pluralization
 * 
 * Environment Variables:
 * - DEFAULT_LOCALE: Default language (e.g., 'en')
 * - SUPPORTED_LOCALES: Comma-separated list of supported locales
 */
@Injectable()
export class I18nService {
  private readonly logger = new Logger(I18nService.name);
  private readonly defaultLocale: string;
  private readonly supportedLocales: string[];
  private translations: Map<string, Record<string, string>> = new Map();

  constructor() {
    this.defaultLocale = process.env.DEFAULT_LOCALE || '{{ i18n.defaultLocale | default("en") }}';
    this.supportedLocales = (process.env.SUPPORTED_LOCALES || '{{ i18n.supportedLocales | join(",") | default("en,es,fr,hi") }}').split(',');
    
    // Load translations (in production, load from files or database)
    this.loadTranslations();
  }

  /**
   * Translate a key to the specified locale
   */
  translate(key: string, locale?: string, params: Record<string, any> = {}): string {
    const targetLocale = locale || this.defaultLocale;
    const localeTranslations = this.translations.get(targetLocale) || this.translations.get(this.defaultLocale);
    
    if (!localeTranslations) {
      this.logger.warn(`No translations found for locale: ${targetLocale}`);
      return key;
    }

    let translation = localeTranslations[key];
    if (!translation) {
      // Fallback to default locale
      translation = this.translations.get(this.defaultLocale)?.[key] || key;
    }

    // Interpolate parameters
    return this.interpolate(translation, params);
  }

  /**
   * Short alias for translate
   */
  t(key: string, locale?: string, params: Record<string, any> = {}): string {
    return this.translate(key, locale, params);
  }

  /**
   * Pluralize a translation key
   */
  pluralize(key: string, count: number, locale?: string, params: Record<string, any> = {}): string {
    const pluralKey = count === 1 ? `${key}.one` : `${key}.other`;
    return this.translate(pluralKey, locale, { ...params, count });
  }

  /**
   * Format date according to locale
   */
  formatDate(date: Date, locale?: string, options?: Intl.DateTimeFormatOptions): string {
    const targetLocale = locale || this.defaultLocale;
    return new Intl.DateTimeFormat(targetLocale, options || {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }).format(date);
  }

  /**
   * Format number according to locale
   */
  formatNumber(num: number, locale?: string, options?: Intl.NumberFormatOptions): string {
    const targetLocale = locale || this.defaultLocale;
    return new Intl.NumberFormat(targetLocale, options).format(num);
  }

  /**
   * Format currency according to locale
   */
  formatCurrency(amount: number, currency: string, locale?: string): string {
    const targetLocale = locale || this.defaultLocale;
    return new Intl.NumberFormat(targetLocale, {
      style: 'currency',
      currency,
    }).format(amount);
  }

  /**
   * Format relative time (e.g., "2 days ago")
   */
  formatRelativeTime(date: Date, locale?: string): string {
    const targetLocale = locale || this.defaultLocale;
    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
    
    const rtf = new Intl.RelativeTimeFormat(targetLocale, { numeric: 'auto' });
    
    if (diffInSeconds < 60) return rtf.format(-diffInSeconds, 'second');
    if (diffInSeconds < 3600) return rtf.format(-Math.floor(diffInSeconds / 60), 'minute');
    if (diffInSeconds < 86400) return rtf.format(-Math.floor(diffInSeconds / 3600), 'hour');
    if (diffInSeconds < 2592000) return rtf.format(-Math.floor(diffInSeconds / 86400), 'day');
    if (diffInSeconds < 31536000) return rtf.format(-Math.floor(diffInSeconds / 2592000), 'month');
    return rtf.format(-Math.floor(diffInSeconds / 31536000), 'year');
  }

  /**
   * Check if a locale is supported
   */
  isSupported(locale: string): boolean {
    return this.supportedLocales.includes(locale);
  }

  /**
   * Get all supported locales
   */
  getSupportedLocales(): string[] {
    return [...this.supportedLocales];
  }

  /**
   * Detect locale from request
   */
  detectLocale(req: Request): string {
    // Check query param first
    const queryLocale = req.query['lang'] as string;
    if (queryLocale && this.isSupported(queryLocale)) {
      return queryLocale;
    }

    // Check header
    const headerLocale = req.headers['accept-language']?.split(',')[0]?.split('-')[0];
    if (headerLocale && this.isSupported(headerLocale)) {
      return headerLocale;
    }

    // Check cookie
    const cookieLocale = req.cookies?.['locale'];
    if (cookieLocale && this.isSupported(cookieLocale)) {
      return cookieLocale;
    }

    return this.defaultLocale;
  }

  // Private helpers

  private interpolate(str: string, params: Record<string, any>): string {
    return str.replace(/\{\{(\w+)\}\}/g, (_, key) => {
      return params[key] !== undefined ? String(params[key]) : `{{${key}}}`;
    });
  }

  private loadTranslations(): void {
    // In production, load from JSON files or database
    // This is sample data for demonstration
    this.translations.set('en', {
      'welcome': 'Welcome',
      'greeting': 'Hello, {{name}}!',
      'items.one': '1 item',
      'items.other': '{{count}} items',
      'error.notFound': 'Resource not found',
      'error.unauthorized': 'You are not authorized',
    });

    this.translations.set('es', {
      'welcome': 'Bienvenido',
      'greeting': '¡Hola, {{name}}!',
      'items.one': '1 artículo',
      'items.other': '{{count}} artículos',
      'error.notFound': 'Recurso no encontrado',
      'error.unauthorized': 'No estás autorizado',
    });

    this.translations.set('hi', {
      'welcome': 'स्वागत है',
      'greeting': 'नमस्ते, {{name}}!',
      'items.one': '1 आइटम',
      'items.other': '{{count}} आइटम',
      'error.notFound': 'संसाधन नहीं मिला',
      'error.unauthorized': 'आप अधिकृत नहीं हैं',
    });

    this.logger.log(`Loaded translations for ${this.translations.size} locales`);
  }
}

/**
 * I18n Middleware - Sets locale on request
 */
@Injectable()
export class I18nMiddleware implements NestMiddleware {
  constructor(private readonly i18nService: I18nService) {}

  use(req: Request, res: Response, next: NextFunction): void {
    const locale = this.i18nService.detectLocale(req);
    req['locale'] = locale;
    res.setHeader('Content-Language', locale);
    next();
  }
}
