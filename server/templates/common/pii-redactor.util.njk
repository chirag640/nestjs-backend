/**
 * PII (Personally Identifiable Information) Redaction Utility
 * 
 * Redacts sensitive data from objects for safe logging.
 * 
 * Usage:
 * ```typescript
 * const safeData = redactSensitiveData(userRequest);
 * console.log(safeData); // { email: "[REDACTED]", password: "[REDACTED]", name: "John" }
 * ```
 */

// Fields that should be redacted
const SENSITIVE_FIELDS = new Set([
  'password',
  'newPassword',
  'oldPassword',
  'confirmPassword',
  'token',
  'accessToken',
  'refreshToken',
  'apiKey',
  'secret',
  'secretKey',
  'authorization',
  'cookie',
  'sessionId',
  'ssn',
  'socialSecurityNumber',
  'creditCard',
  'cardNumber',
  'cvv',
  'pin',
  'otp',
  'verificationCode',
]);

// Fields that should be partially masked
const PARTIAL_MASK_FIELDS = new Set([
  'email',
  'phone',
  'phoneNumber',
]);

const REDACTED = '[REDACTED]';

/**
 * Redact sensitive data from an object
 */
export function redactSensitiveData<T>(data: T): T {
  if (data === null || data === undefined) {
    return data;
  }

  if (typeof data !== 'object') {
    return data;
  }

  if (Array.isArray(data)) {
    return data.map((item) => redactSensitiveData(item)) as T;
  }

  const result: Record<string, any> = {};

  for (const [key, value] of Object.entries(data as Record<string, any>)) {
    const lowerKey = key.toLowerCase();

    // Full redaction
    if (SENSITIVE_FIELDS.has(lowerKey)) {
      result[key] = REDACTED;
    }
    // Partial masking
    else if (PARTIAL_MASK_FIELDS.has(lowerKey) && typeof value === 'string') {
      result[key] = maskString(value, lowerKey);
    }
    // Recursive redaction for nested objects
    else if (typeof value === 'object' && value !== null) {
      result[key] = redactSensitiveData(value);
    }
    // Pass through safe values
    else {
      result[key] = value;
    }
  }

  return result as T;
}

/**
 * Mask a string partially based on field type
 */
function maskString(value: string, fieldType: string): string {
  if (!value || value.length < 4) {
    return REDACTED;
  }

  if (fieldType === 'email') {
    const [local, domain] = value.split('@');
    if (!domain) return REDACTED;
    const maskedLocal = local.length > 2 
      ? local[0] + '*'.repeat(local.length - 2) + local[local.length - 1]
      : '*'.repeat(local.length);
    return `${maskedLocal}@${domain}`;
  }

  if (fieldType === 'phone' || fieldType === 'phonenumber') {
    // Show last 4 digits
    return '*'.repeat(value.length - 4) + value.slice(-4);
  }

  // Default: show first and last character
  return value[0] + '*'.repeat(value.length - 2) + value[value.length - 1];
}

/**
 * Check if a field name is sensitive
 */
export function isSensitiveField(fieldName: string): boolean {
  return SENSITIVE_FIELDS.has(fieldName.toLowerCase());
}

/**
 * Add custom sensitive field
 */
export function addSensitiveField(fieldName: string): void {
  SENSITIVE_FIELDS.add(fieldName.toLowerCase());
}
