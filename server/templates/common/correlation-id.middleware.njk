import { Injectable, NestMiddleware, Logger } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { v4 as uuidv4 } from 'uuid';

/**
 * Correlation ID Middleware
 * 
 * Adds a unique correlation ID to each request for tracing across services.
 * The ID is:
 * 1. Taken from X-Correlation-ID header if present (for distributed tracing)
 * 2. Generated as UUID v4 if not present
 * 3. Added to response headers for client access
 * 4. Stored in request for logging/context access
 */
@Injectable()
export class CorrelationIdMiddleware implements NestMiddleware {
  private readonly logger = new Logger('CorrelationId');

  use(req: Request, res: Response, next: NextFunction): void {
    // Check for existing correlation ID from upstream service
    const existingId = req.headers['x-correlation-id'] as string;
    const correlationId = existingId || uuidv4();

    // Set correlation ID on request for downstream access
    (req as any).correlationId = correlationId;
    req.headers['x-correlation-id'] = correlationId;
    
    // Also set as request ID for backward compatibility
    req.headers['x-request-id'] = correlationId;

    // Add to response headers
    res.setHeader('X-Correlation-ID', correlationId);
    res.setHeader('X-Request-ID', correlationId);

    // Log for tracing
    this.logger.debug(`Request ${req.method} ${req.url} [${correlationId}]`);

    next();
  }
}

/**
 * Helper to get correlation ID from request
 */
export function getCorrelationId(req: Request): string {
  return (req as any).correlationId || req.headers['x-correlation-id'] || 'unknown';
}
