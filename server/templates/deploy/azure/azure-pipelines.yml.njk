# {{ project.name }} - Azure App Service Deployment

# azure-pipelines.yml - CI/CD for Azure App Service
trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'YOUR_AZURE_SUBSCRIPTION'
  webAppName: '{{ project.name | lower | replace(" ", "-") }}'
  resourceGroup: '{{ project.name | lower | replace(" ", "-") }}-rg'
  nodeVersion: '20.x'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: Build
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: |
              npm ci
              npm run build
              npm prune --production
            displayName: 'Install and Build'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true

          - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            artifact: drop

  - stage: Deploy
    displayName: 'Deploy Stage'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(webAppName)'
                    package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'npm run start:prod'

---
# App Service Configuration (app-settings.json)
# Apply via: az webapp config appsettings set --resource-group $RG --name $APP --settings @app-settings.json
[
  { "name": "NODE_ENV", "value": "production" },
  { "name": "PORT", "value": "8080" },
  { "name": "WEBSITE_NODE_DEFAULT_VERSION", "value": "~20" },
  { "name": "SCM_DO_BUILD_DURING_DEPLOYMENT", "value": "false" },
  { "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE", "value": "false" }
]
