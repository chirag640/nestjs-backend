# {{ project.name }} - DigitalOcean App Platform

# .do/app.yaml - App Platform Spec
# https://docs.digitalocean.com/products/app-platform/reference/app-spec/

name: {{ project.name | lower | replace(' ', '-') }}
region: nyc

services:
  - name: api
    github:
      repo: YOUR_GITHUB_USERNAME/{{ project.name | lower | replace(' ', '-') }}
      branch: main
      deploy_on_push: true
    
    # Build
    build_command: npm ci && npm run build
    run_command: npm run start:prod
    
    # Resources
    instance_count: 1
    instance_size_slug: basic-xxs # basic-xxs, basic-xs, basic-s, basic-m
    
    # Environment
    envs:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "8080"
      
      # Database (linked)
      {% if database.type === 'MongoDB' %}
      - key: MONGODB_URI
        scope: RUN_TIME
        type: SECRET
      {% else %}
      - key: DATABASE_URL
        scope: RUN_TIME
        value: ${db.DATABASE_URL}
      {% endif %}
      
      # Secrets
      - key: JWT_SECRET
        scope: RUN_TIME
        type: SECRET
      - key: JWT_REFRESH_SECRET
        scope: RUN_TIME
        type: SECRET
    
    # Health check
    health_check:
      http_path: /health/live
      initial_delay_seconds: 30
      period_seconds: 10
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3
    
    # HTTP config
    http_port: 8080
    routes:
      - path: /

{% if database.type !== 'MongoDB' %}
databases:
  - name: db
    engine: PG # PG, MYSQL
    version: "15"
    size: db-s-dev-database # Development tier
    num_nodes: 1
{% endif %}

# Redis (optional)
# services:
#   - name: redis
#     image:
#       registry_type: DOCKER_HUB
#       registry: library
#       repository: redis
#       tag: alpine
#     internal_ports:
#       - 6379
