# {{ project.name }} - Render Deployment

# Render Blueprint Specification
# https://render.com/docs/blueprint-spec

services:
  # Web Service (NestJS API)
  - type: web
    name: {{ project.name | lower | replace(' ', '-') }}-api
    runtime: node
    region: oregon # or singapore, frankfurt, ohio
    plan: starter # starter, standard, pro
    
    # Build configuration
    buildCommand: npm ci && npm run build
    startCommand: npm run start:prod
    
    # Health check
    healthCheckPath: /health/live
    
    # Environment
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      
      # Database (use Render PostgreSQL or MongoDB Atlas)
      {% if database.type === 'MongoDB' %}
      - key: MONGODB_URI
        fromDatabase:
          name: {{ project.name | lower | replace(' ', '-') }}-db
          property: connectionString
      {% else %}
      - key: DATABASE_URL
        fromDatabase:
          name: {{ project.name | lower | replace(' ', '-') }}-db
          property: connectionString
      {% endif %}
      
      # JWT Secrets (generate these)
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      
      # Redis for caching/queues (optional)
      - key: REDIS_URL
        fromService:
          name: {{ project.name | lower | replace(' ', '-') }}-redis
          type: redis
          property: connectionString
    
    # Auto-deploy from Git
    autoDeploy: true
    
    # Scaling (Pro plan)
    # scaling:
    #   minInstances: 1
    #   maxInstances: 3
    #   targetMemoryPercent: 80
    #   targetCPUPercent: 80

  # Redis Service (for Bull queues & caching)
  - type: redis
    name: {{ project.name | lower | replace(' ', '-') }}-redis
    plan: starter # starter, standard
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

databases:
  {% if database.type === 'MongoDB' %}
  # Note: Render doesn't host MongoDB directly
  # Use MongoDB Atlas and set MONGODB_URI manually
  {% else %}
  - name: {{ project.name | lower | replace(' ', '-') }}-db
    plan: starter # starter, standard, pro
    databaseName: {{ project.name | lower | replace(' ', '_') }}
    {% if database.type === 'PostgreSQL' %}
    postgresMajorVersion: 15
    {% endif %}
  {% endif %}

# Cron Jobs (optional)
# jobs:
#   - name: cleanup-job
#     schedule: "0 0 * * *"
#     buildCommand: npm ci
#     startCommand: npm run job:cleanup
