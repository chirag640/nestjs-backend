# {{ project.name }} - AWS Elastic Beanstalk Deployment

# .ebextensions/nodecommand.config
option_settings:
  aws:elasticbeanstalk:container:nodejs:
    NodeCommand: "npm run start:prod"
    NodeVersion: 20.x
    
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: production
    PORT: 8080
    
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx
    
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.small
    
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 4
    
  aws:elasticbeanstalk:environment:
    LoadBalancerType: application
    
  aws:elbv2:listener:443:
    Protocol: HTTPS
    SSLCertificateArns: arn:aws:acm:REGION:ACCOUNT:certificate/CERT-ID

# Health check
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: /health/live

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/01_run_migrations.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/current
      npm run migration:run || true

container_commands:
  01_build:
    command: "npm ci && npm run build"
    leader_only: true
