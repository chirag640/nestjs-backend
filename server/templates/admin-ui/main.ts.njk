/**
 * Admin UI - Main Application Entry
 */

// Simple client-side router and app initialization
class AdminApp {
  private _currentRoute: string = '';
  private routes: Map<string, () => void> = new Map();

  constructor() {
    this.setupRoutes();
    this.handleRoute();
    window.addEventListener('popstate', () => this.handleRoute());
  }

  private setupRoutes() {
    this.routes.set('/admin', () => this.renderDashboard());
    this.routes.set('/admin/', () => this.renderDashboard());
    this.routes.set('/admin/dashboard', () => this.renderDashboard());
    this.routes.set('/admin/rules', () => this.renderRulesPage());
    this.routes.set('/admin/logs', () => this.renderLogsPage());
  }

  public navigate(path: string) {
    window.history.pushState({}, '', path);
    this.handleRoute();
  }

  private handleRoute() {
    const path = window.location.pathname;
    const handler = this.routes.get(path) || this.routes.get('/admin/dashboard');
    if (handler) {
      handler();
    }
  }

  private renderLayout(content: string, activePage: string) {
    const root = document.getElementById('root');
    if (!root) return;

    root.innerHTML = `
      <div class="admin-layout">
        <aside class="sidebar">
          <div class="sidebar-logo">
            <div class="sidebar-logo-icon">üîê</div>
            <span class="sidebar-logo-text">Permission Manager</span>
          </div>
          
          <nav class="sidebar-nav">
            <div class="nav-section">
              <div class="nav-section-title">Overview</div>
              <a href="/admin/dashboard" class="nav-link ${activePage === 'dashboard' ? 'active' : ''}" data-route>
                <span class="nav-link-icon">üìä</span>
                <span>Dashboard</span>
              </a>
            </div>
            
            <div class="nav-section">
              <div class="nav-section-title">Access Control</div>
              <a href="/admin/rules" class="nav-link ${activePage === 'rules' ? 'active' : ''}" data-route>
                <span class="nav-link-icon">üìã</span>
                <span>Field Access Rules</span>
              </a>
              <a href="/admin/logs" class="nav-link ${activePage === 'logs' ? 'active' : ''}" data-route>
                <span class="nav-link-icon">üìú</span>
                <span>Audit Logs</span>
              </a>
            </div>
            
            <div class="nav-section">
              <div class="nav-section-title">Actions</div>
              <button class="nav-link" id="export-btn">
                <span class="nav-link-icon">üì§</span>
                <span>Export Rules</span>
              </button>
              <button class="nav-link" id="import-btn">
                <span class="nav-link-icon">üì•</span>
                <span>Import Rules</span>
              </button>
            </div>
          </nav>
        </aside>
        
        <main class="main-content">
          ${content}
        </main>
      </div>
    `;

    // Add navigation event listeners
    document.querySelectorAll('[data-route]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
        if (href) this.navigate(href);
      });
    });

    // Export/Import handlers
    document.getElementById('export-btn')?.addEventListener('click', () => this.handleExport());
    document.getElementById('import-btn')?.addEventListener('click', () => this.handleImport());
  }

  private async renderDashboard() {
    this.renderLayout(`
      <div class="page-header">
        <div>
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Field-Level Access Control Overview</p>
        </div>
      </div>
      
      <div class="stats-grid" id="stats-container">
        <div class="stat-card">
          <div class="stat-card-icon primary">üìä</div>
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">Total Access Attempts</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-icon success">‚úÖ</div>
          <div class="stat-value" id="stat-granted">-</div>
          <div class="stat-label">Granted</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-icon danger">üö´</div>
          <div class="stat-value" id="stat-denied">-</div>
          <div class="stat-label">Denied</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-icon warning">üìà</div>
          <div class="stat-value" id="stat-rate">-</div>
          <div class="stat-label">Denial Rate</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Recent Denied Access</h3>
          <a href="/admin/logs" class="btn btn-secondary btn-sm" data-route>View All</a>
        </div>
        <div class="table-container">
          <table class="table" id="recent-denied-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>User</th>
                <th>Role</th>
                <th>Entity</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody id="recent-denied-body">
              <tr>
                <td colspan="5" class="empty-state">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `, 'dashboard');

    // Re-add route listeners for the new button
    document.querySelectorAll('[data-route]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
        if (href) this.navigate(href);
      });
    });

    // Load stats
    this.loadDashboardData();
  }

  private async loadDashboardData() {
    try {
      // Load stats
      const statsRes = await fetch('/field-access/stats');
      if (statsRes.ok) {
        const stats = await statsRes.json();
        document.getElementById('stat-total')!.textContent = stats.total.toLocaleString();
        document.getElementById('stat-granted')!.textContent = stats.granted.toLocaleString();
        document.getElementById('stat-denied')!.textContent = stats.denied.toLocaleString();
        document.getElementById('stat-rate')!.textContent = stats.denialRate;
      }

      // Load recent denied
      const logsRes = await fetch('/field-access/logs/denied?limit=5');
      const tbody = document.getElementById('recent-denied-body')!;
      
      if (logsRes.ok) {
        const logs = await logsRes.json();
        if (logs.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-state">
                <div class="empty-state-icon">‚úÖ</div>
                <div class="empty-state-title">No Denied Access</div>
                <p>All access attempts have been granted</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = logs.map((log: any) => `
            <tr>
              <td>${new Date(log.createdAt).toLocaleString()}</td>
              <td>${log.userId || 'Unknown'}</td>
              <td><span class="badge badge-info">${log.role}</span></td>
              <td>${log.entityName}</td>
              <td>${log.denialReason || 'Unauthorized field access'}</td>
            </tr>
          `).join('');
        }
      }
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
    }
  }

  private async renderRulesPage() {
    this.renderLayout(`
      <div class="page-header">
        <div>
          <h1 class="page-title">Field Access Rules</h1>
          <p class="page-subtitle">Manage role-based field access permissions</p>
        </div>
        <button class="btn btn-primary" id="add-rule-btn">
          <span>‚ûï</span> Add Rule
        </button>
      </div>
      
      <div class="search-bar">
        <div class="search-input-wrapper">
          <span class="search-icon">üîç</span>
          <input type="text" class="search-input" placeholder="Search rules..." id="search-rules">
        </div>
        <select class="form-select" style="width: auto;" id="filter-role">
          <option value="">All Roles</option>
        </select>
      </div>
      
      <div class="card">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Role</th>
                <th>Entity</th>
                <th>Allow</th>
                <th>Deny</th>
                <th>Self Only</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rules-body">
              <tr>
                <td colspan="7" class="empty-state">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div id="rule-modal"></div>
    `, 'rules');

    document.getElementById('add-rule-btn')?.addEventListener('click', () => this.showRuleModal());
    document.getElementById('search-rules')?.addEventListener('input', (e) => this.filterRules((e.target as HTMLInputElement).value));
    
    this.loadRules();
  }

  private allRules: any[] = [];

  private async loadRules() {
    try {
      const res = await fetch('/field-access/rules');
      const tbody = document.getElementById('rules-body')!;
      const roleFilter = document.getElementById('filter-role') as HTMLSelectElement;
      
      if (res.ok) {
        this.allRules = await res.json();
        
        // Populate role filter
        const roles = [...new Set(this.allRules.map(r => r.role))];
        roleFilter.innerHTML = '<option value="">All Roles</option>' + 
          roles.map(r => `<option value="${r}">${r}</option>`).join('');
        
        roleFilter.addEventListener('change', () => this.filterRules());
        
        this.renderRulesTable();
      }
    } catch (error) {
      console.error('Failed to load rules:', error);
    }
  }

  private filterRules(search: string = '') {
    const roleFilter = (document.getElementById('filter-role') as HTMLSelectElement)?.value || '';
    const searchInput = (document.getElementById('search-rules') as HTMLInputElement)?.value || search;
    
    const filtered = this.allRules.filter(rule => {
      const matchesRole = !roleFilter || rule.role === roleFilter;
      const matchesSearch = !searchInput || 
        rule.role.toLowerCase().includes(searchInput.toLowerCase()) ||
        (rule.entityName || '').toLowerCase().includes(searchInput.toLowerCase()) ||
        (rule.description || '').toLowerCase().includes(searchInput.toLowerCase());
      return matchesRole && matchesSearch;
    });
    
    this.renderRulesTable(filtered);
  }

  private renderRulesTable(rules: any[] = this.allRules) {
    const tbody = document.getElementById('rules-body')!;
    
    if (rules.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-title">No Rules Found</div>
            <p>Create your first field access rule</p>
          </td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = rules.map(rule => `
      <tr data-id="${rule._id}">
        <td><span class="badge badge-info">${rule.role}</span></td>
        <td>${rule.entityName || '<em>Global</em>'}</td>
        <td>${(rule.allow || []).slice(0, 3).join(', ')}${(rule.allow || []).length > 3 ? '...' : ''}</td>
        <td>${(rule.deny || []).slice(0, 3).join(', ')}${(rule.deny || []).length > 3 ? '...' : ''}</td>
        <td>${rule.allowSelfOnly ? '‚úÖ' : '‚ùå'}</td>
        <td>
          <span class="badge ${rule.isActive ? 'badge-success' : 'badge-warning'}">
            ${rule.isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <button class="btn btn-secondary btn-sm edit-rule" data-id="${rule._id}">Edit</button>
          <button class="btn btn-danger btn-sm delete-rule" data-id="${rule._id}">Delete</button>
        </td>
      </tr>
    `).join('');

    // Add event listeners
    tbody.querySelectorAll('.edit-rule').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = (btn as HTMLElement).dataset.id;
        const rule = this.allRules.find(r => r._id === id);
        if (rule) this.showRuleModal(rule);
      });
    });

    tbody.querySelectorAll('.delete-rule').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = (btn as HTMLElement).dataset.id;
        if (id) this.deleteRule(id);
      });
    });
  }

  private showRuleModal(rule?: any) {
    const modal = document.getElementById('rule-modal')!;
    const isEdit = !!rule;
    
    modal.innerHTML = `
      <div class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">${isEdit ? 'Edit' : 'Create'} Field Access Rule</h3>
            <button class="modal-close" id="close-modal">&times;</button>
          </div>
          <form class="modal-body" id="rule-form">
            <div class="form-group">
              <label class="form-label">Role *</label>
              <input type="text" class="form-input" name="role" value="${rule?.role || ''}" required placeholder="e.g., user, admin, doctor">
            </div>
            <div class="form-group">
              <label class="form-label">Entity Name</label>
              <input type="text" class="form-input" name="entityName" value="${rule?.entityName || ''}" placeholder="e.g., Worker, Order (leave empty for global)">
            </div>
            <div class="form-group">
              <label class="form-label">Allow Fields (comma-separated)</label>
              <input type="text" class="form-input" name="allow" value="${(rule?.allow || []).join(', ')}" placeholder="e.g., *, name, email">
            </div>
            <div class="form-group">
              <label class="form-label">Deny Fields (comma-separated)</label>
              <input type="text" class="form-input" name="deny" value="${(rule?.deny || []).join(', ')}" placeholder="e.g., ssn, salary, medicalNotes">
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-textarea" name="description" rows="2" placeholder="Optional description...">${rule?.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label class="toggle-switch">
                <input type="checkbox" name="allowSelfOnly" ${rule?.allowSelfOnly ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
              <span style="margin-left: 0.75rem;">Restrict to own records only</span>
            </div>
          </form>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-modal">Cancel</button>
            <button class="btn btn-primary" id="save-rule">${isEdit ? 'Update' : 'Create'} Rule</button>
          </div>
        </div>
      </div>
    `;

    document.getElementById('close-modal')?.addEventListener('click', () => modal.innerHTML = '');
    document.getElementById('cancel-modal')?.addEventListener('click', () => modal.innerHTML = '');
    document.getElementById('save-rule')?.addEventListener('click', () => this.saveRule(rule?._id));
  }

  private async saveRule(id?: string) {
    const form = document.getElementById('rule-form') as HTMLFormElement;
    const formData = new FormData(form);
    
    const data = {
      role: formData.get('role') as string,
      entityName: formData.get('entityName') as string || undefined,
      allow: (formData.get('allow') as string).split(',').map(s => s.trim()).filter(Boolean),
      deny: (formData.get('deny') as string).split(',').map(s => s.trim()).filter(Boolean),
      description: formData.get('description') as string || undefined,
      allowSelfOnly: (form.querySelector('[name="allowSelfOnly"]') as HTMLInputElement)?.checked || false,
    };

    try {
      const res = await fetch(id ? `/field-access/rules/${id}` : '/field-access/rules', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        document.getElementById('rule-modal')!.innerHTML = '';
        this.loadRules();
      } else {
        alert('Failed to save rule');
      }
    } catch (error) {
      alert('Error saving rule: ' + error);
    }
  }

  private async deleteRule(id: string) {
    if (!confirm('Are you sure you want to delete this rule?')) return;
    
    try {
      const res = await fetch(`/field-access/rules/${id}`, { method: 'DELETE' });
      if (res.ok) {
        this.loadRules();
      } else {
        alert('Failed to delete rule');
      }
    } catch (error) {
      alert('Error deleting rule: ' + error);
    }
  }

  private async renderLogsPage() {
    this.renderLayout(`
      <div class="page-header">
        <div>
          <h1 class="page-title">Audit Logs</h1>
          <p class="page-subtitle">Monitor field access attempts</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-secondary" id="show-all-logs">All Logs</button>
          <button class="btn btn-danger" id="show-denied-logs">Denied Only</button>
        </div>
      </div>
      
      <div class="card">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Role</th>
                <th>Entity</th>
                <th>Action</th>
                <th>Status</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="logs-body">
              <tr>
                <td colspan="7" class="empty-state">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `, 'logs');

    document.getElementById('show-all-logs')?.addEventListener('click', () => this.loadLogs(false));
    document.getElementById('show-denied-logs')?.addEventListener('click', () => this.loadLogs(true));
    
    this.loadLogs();
  }

  private async loadLogs(deniedOnly: boolean = false) {
    try {
      const endpoint = deniedOnly ? '/field-access/logs/denied' : '/field-access/logs';
      const res = await fetch(`${endpoint}?limit=50`);
      const tbody = document.getElementById('logs-body')!;
      
      if (res.ok) {
        const logs = await res.json();
        
        if (logs.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="empty-state">
                <div class="empty-state-icon">üìú</div>
                <div class="empty-state-title">No Logs Found</div>
                <p>Access logs will appear here once field access checks occur</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = logs.map((log: any) => `
          <tr>
            <td>${new Date(log.createdAt).toLocaleString()}</td>
            <td>${log.userId || 'Unknown'}</td>
            <td><span class="badge badge-info">${log.role}</span></td>
            <td>${log.entityName}</td>
            <td><span class="badge badge-${log.action === 'delete' ? 'danger' : log.action === 'write' ? 'warning' : 'info'}">${log.action}</span></td>
            <td>
              <span class="badge ${log.granted ? 'badge-success' : 'badge-danger'}">
                ${log.granted ? 'Granted' : 'Denied'}
              </span>
            </td>
            <td>${log.denialReason || log.deniedFields?.join(', ') || '-'}</td>
          </tr>
        `).join('');
      }
    } catch (error) {
      console.error('Failed to load logs:', error);
    }
  }

  private async handleExport() {
    try {
      const res = await fetch('/field-access/export');
      if (res.ok) {
        const rules = await res.json();
        const blob = new Blob([JSON.stringify(rules, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'field-access-rules.json';
        a.click();
        URL.revokeObjectURL(url);
      }
    } catch (error) {
      alert('Export failed: ' + error);
    }
  }

  private handleImport() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e: any) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const rules = JSON.parse(text);
        
        if (!confirm(`Import ${rules.length} rules? This will replace all existing rules.`)) return;
        
        const res = await fetch('/field-access/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rules),
        });
        
        if (res.ok) {
          alert('Rules imported successfully!');
          window.location.reload();
        } else {
          alert('Import failed');
        }
      } catch (error) {
        alert('Invalid JSON file: ' + error);
      }
    };
    input.click();
  }
}

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
  new AdminApp();
});
