import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { Document, Types } from 'mongoose';

export type WebAuthnCredentialDocument = WebAuthnCredential & Document;

/**
 * WebAuthn Credential Schema
 * 
 * Stores public key credentials for biometric/passkey authentication.
 * Each user can have multiple credentials (e.g., iPhone FaceID, Security Key)
 * 
 * @see https://simplewebauthn.dev/
 * @requires mobileConfig.biometricAuth.enabled = true
 */
@Schema({
  timestamps: true,
  collection: 'webauthn_credentials',
})
export class WebAuthnCredential {
  @Prop({ type: Types.ObjectId, ref: 'User', required: true, index: true })
  userId: Types.ObjectId;

  @Prop({ required: true, unique: true })
  credentialId: string; // Base64URL-encoded credential ID

  @Prop({ required: true })
  credentialPublicKey: string; // Base64URL-encoded public key

  @Prop({ required: true })
  counter: number; // Signature counter for replay attack prevention

  @Prop({ type: String, required: false })
  deviceType: 'singleDevice' | 'multiDevice'; // Single device or synced passkey

  @Prop({ default: false })
  backedUp: boolean; // Whether this credential is backed up (synced passkey)

  @Prop({ type: [String], default: [] })
  transports: string[]; // ['internal', 'hybrid', 'usb', 'ble', 'nfc']

  @Prop({ required: false })
  friendlyName: string; // User-assigned name like "Work Laptop" or "iPhone FaceID"

  @Prop({ type: String, required: false })
  aaguid?: string; // Authenticator Attestation GUID (identifies authenticator model)

  @Prop({ default: Date.now })
  lastUsedAt: Date;

  @Prop({ default: true })
  isActive: boolean;

  // Link to device if applicable
  @Prop({ type: Types.ObjectId, ref: 'Device', required: false })
  deviceId?: Types.ObjectId;

  // Timestamps
  createdAt: Date;
  updatedAt: Date;
}

export const WebAuthnCredentialSchema = SchemaFactory.createForClass(WebAuthnCredential);

// Indexes for efficient queries
WebAuthnCredentialSchema.index({ userId: 1, isActive: 1 });
WebAuthnCredentialSchema.index({ credentialId: 1 }, { unique: true });
