import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import * as twilio from 'twilio';

export interface SmsPayload {
  to: string;
  body: string;
  mediaUrls?: string[];
}

export interface SmsResult {
  success: boolean;
  sid?: string;
  error?: string;
}

/**
 * Twilio SMS Service
 * 
 * Sends SMS messages and handles verification via Twilio.
 * 
 * ## Setup
 * 1. Create Twilio account at https://www.twilio.com
 * 2. Get Account SID and Auth Token from dashboard
 * 3. Purchase a phone number
 * 4. Set environment variables:
 *    - TWILIO_ACCOUNT_SID
 *    - TWILIO_AUTH_TOKEN
 *    - TWILIO_PHONE_NUMBER
 * 
 * ## Usage
 * ```typescript
 * // Send SMS
 * await smsService.send({
 *   to: '+15551234567',
 *   body: 'Your verification code is 123456',
 * });
 * 
 * // Send OTP
 * const code = await smsService.sendOtp('+15551234567');
 * 
 * // Verify OTP
 * const valid = await smsService.verifyOtp('+15551234567', '123456');
 * ```
 */
@Injectable()
export class TwilioSmsService implements OnModuleInit {
  private readonly logger = new Logger(TwilioSmsService.name);
  private client: twilio.Twilio | null = null;
  private readonly fromNumber: string;
  private readonly enabled: boolean;

  // In-memory OTP storage (use Redis in production)
  private otpStore = new Map<string, { code: string; expiresAt: Date }>();

  constructor(private readonly configService: ConfigService) {
    this.fromNumber = configService.get('TWILIO_PHONE_NUMBER', '');
    this.enabled = !!(
      configService.get('TWILIO_ACCOUNT_SID') &&
      configService.get('TWILIO_AUTH_TOKEN') &&
      this.fromNumber
    );
  }

  onModuleInit() {
    if (!this.enabled) {
      this.logger.warn('Twilio is not configured. SMS notifications are disabled.');
      return;
    }

    this.client = twilio(
      this.configService.get('TWILIO_ACCOUNT_SID'),
      this.configService.get('TWILIO_AUTH_TOKEN'),
    );
    this.logger.log('Twilio client initialized');
  }

  /**
   * Send SMS message
   */
  async send(payload: SmsPayload): Promise<SmsResult> {
    if (!this.enabled || !this.client) {
      return { success: false, error: 'Twilio not configured' };
    }

    try {
      const message = await this.client.messages.create({
        to: payload.to,
        from: this.fromNumber,
        body: payload.body,
        mediaUrl: payload.mediaUrls,
      });

      this.logger.debug(`SMS sent: ${message.sid}`);
      return { success: true, sid: message.sid };
    } catch (error) {
      this.logger.error(`SMS failed: ${error.message}`);
      return { success: false, error: error.message };
    }
  }

  /**
   * Send bulk SMS messages
   */
  async sendBulk(messages: SmsPayload[]): Promise<SmsResult[]> {
    return Promise.all(messages.map((msg) => this.send(msg)));
  }

  /**
   * Send OTP code
   * Returns the generated code (for testing) - don't expose in production
   */
  async sendOtp(
    phoneNumber: string,
    options: { length?: number; expiresIn?: number } = {},
  ): Promise<{ success: boolean; error?: string }> {
    const length = options.length || 6;
    const expiresIn = options.expiresIn || 5; // minutes

    // Generate OTP
    const code = this.generateOtp(length);
    const expiresAt = new Date(Date.now() + expiresIn * 60 * 1000);

    // Store OTP
    this.otpStore.set(phoneNumber, { code, expiresAt });

    // Send SMS
    const result = await this.send({
      to: phoneNumber,
      body: `Your verification code is: ${code}. Valid for ${expiresIn} minutes.`,
    });

    if (!result.success) {
      this.otpStore.delete(phoneNumber);
    }

    return { success: result.success, error: result.error };
  }

  /**
   * Verify OTP code
   */
  async verifyOtp(phoneNumber: string, code: string): Promise<boolean> {
    const stored = this.otpStore.get(phoneNumber);

    if (!stored) {
      return false;
    }

    // Check expiration
    if (new Date() > stored.expiresAt) {
      this.otpStore.delete(phoneNumber);
      return false;
    }

    // Check code
    if (stored.code !== code) {
      return false;
    }

    // Valid - remove from store
    this.otpStore.delete(phoneNumber);
    return true;
  }

  /**
   * Make phone call (optional, for 2FA or alerts)
   */
  async makeCall(
    to: string,
    message: string,
  ): Promise<{ success: boolean; sid?: string; error?: string }> {
    if (!this.enabled || !this.client) {
      return { success: false, error: 'Twilio not configured' };
    }

    try {
      const call = await this.client.calls.create({
        to,
        from: this.fromNumber,
        twiml: `<Response><Say>${message}</Say></Response>`,
      });

      return { success: true, sid: call.sid };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  /**
   * Check if phone number is valid
   */
  async validatePhoneNumber(phoneNumber: string): Promise<{
    valid: boolean;
    countryCode?: string;
    nationalFormat?: string;
  }> {
    if (!this.enabled || !this.client) {
      return { valid: false };
    }

    try {
      const lookup = await this.client.lookups.v2.phoneNumbers(phoneNumber).fetch();
      return {
        valid: lookup.valid,
        countryCode: lookup.countryCode,
        nationalFormat: lookup.nationalFormat,
      };
    } catch (error) {
      return { valid: false };
    }
  }

  private generateOtp(length: number): string {
    const digits = '0123456789';
    let otp = '';
    for (let i = 0; i < length; i++) {
      otp += digits[Math.floor(Math.random() * digits.length)];
    }
    return otp;
  }
}
