import { Injectable } from '@nestjs/common';
import { register, Counter, Histogram, Gauge, collectDefaultMetrics } from 'prom-client';

@Injectable()
export class MetricsService {
  // HTTP Metrics
  public readonly httpRequestDuration: Histogram<string>;
  public readonly httpRequestTotal: Counter<string>;
  public readonly httpRequestErrors: Counter<string>;

  // Database Metrics
  public readonly dbQueryDuration: Histogram<string>;
  public readonly dbConnectionsActive: Gauge<string>;

  // Business Metrics
  public readonly authLoginAttempts: Counter<string>;
  public readonly authLoginSuccesses: Counter<string>;
  public readonly authLoginFailures: Counter<string>;

  constructor() {
    // Enable default metrics (CPU, memory, event loop, etc.)
    collectDefaultMetrics({
      prefix: 'nestjs_',
      gcDurationBuckets: [0.001, 0.01, 0.1, 1, 2, 5],
    });

    // HTTP Request Duration (Histogram)
    this.httpRequestDuration = new Histogram({
      name: 'http_request_duration_seconds',
      help: 'Duration of HTTP requests in seconds',
      labelNames: ['method', 'route', 'status_code'],
      buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5, 10],
    });

    // HTTP Request Total (Counter)
    this.httpRequestTotal = new Counter({
      name: 'http_requests_total',
      help: 'Total number of HTTP requests',
      labelNames: ['method', 'route', 'status_code'],
    });

    // HTTP Request Errors (Counter)
    this.httpRequestErrors = new Counter({
      name: 'http_request_errors_total',
      help: 'Total number of HTTP request errors',
      labelNames: ['method', 'route', 'status_code', 'error_type'],
    });

    // Database Query Duration (Histogram)
    this.dbQueryDuration = new Histogram({
      name: 'db_query_duration_seconds',
      help: 'Duration of database queries in seconds',
      labelNames: ['operation', 'collection'],
      buckets: [0.001, 0.01, 0.05, 0.1, 0.5, 1, 2],
    });

    // Database Active Connections (Gauge)
    this.dbConnectionsActive = new Gauge({
      name: 'db_connections_active',
      help: 'Number of active database connections',
    });

    // Authentication Metrics
    this.authLoginAttempts = new Counter({
      name: 'auth_login_attempts_total',
      help: 'Total number of login attempts',
      labelNames: ['provider'],
    });

    this.authLoginSuccesses = new Counter({
      name: 'auth_login_successes_total',
      help: 'Total number of successful logins',
      labelNames: ['provider'],
    });

    this.authLoginFailures = new Counter({
      name: 'auth_login_failures_total',
      help: 'Total number of failed logins',
      labelNames: ['provider', 'reason'],
    });
  }

  /**
   * Get all metrics in Prometheus format
   */
  async getMetrics(): Promise<string> {
    return register.metrics();
  }

  /**
   * Get metrics as JSON (for debugging)
   */
  async getMetricsJSON() {
    return register.getMetricsAsJSON();
  }

  /**
   * Reset all metrics (useful for testing)
   */
  resetMetrics(): void {
    register.resetMetrics();
  }

  /**
   * Record HTTP request
   */
  recordHttpRequest(method: string, route: string, statusCode: number, duration: number): void {
    this.httpRequestDuration.observe(
      { method, route, status_code: statusCode.toString() },
      duration,
    );
    this.httpRequestTotal.inc({
      method,
      route,
      status_code: statusCode.toString(),
    });
  }

  /**
   * Record HTTP error
   */
  recordHttpError(method: string, route: string, statusCode: number, errorType: string): void {
    this.httpRequestErrors.inc({
      method,
      route,
      status_code: statusCode.toString(),
      error_type: errorType,
    });
  }

  /**
   * Record database query
   */
  recordDbQuery(operation: string, collection: string, duration: number): void {
    this.dbQueryDuration.observe({ operation, collection }, duration);
  }

  /**
   * Update active database connections
   */
  setDbConnectionsActive(count: number): void {
    this.dbConnectionsActive.set(count);
  }

  /**
   * Record authentication attempt
   */
  recordAuthAttempt(provider: string = 'local'): void {
    this.authLoginAttempts.inc({ provider });
  }

  /**
   * Record successful authentication
   */
  recordAuthSuccess(provider: string = 'local'): void {
    this.authLoginSuccesses.inc({ provider });
  }

  /**
   * Record failed authentication
   */
  recordAuthFailure(provider: string = 'local', reason: string = 'invalid_credentials'): void {
    this.authLoginFailures.inc({ provider, reason });
  }
}
