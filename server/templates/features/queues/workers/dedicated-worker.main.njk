import { NestFactory } from '@nestjs/core';
import { Logger, Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { QueueModule } from '../queue.module';

/**
 * Dedicated Worker Module - Only includes queue processing
 * Use this for separate worker processes
 */
@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: '.env',
    }),
    QueueModule,
  ],
})
class WorkerModule {}

async function bootstrap() {
  const logger = new Logger('DedicatedWorker');
  
  logger.log('üöÄ Starting Dedicated Queue Worker...');

  const app = await NestFactory.createApplicationContext(WorkerModule, {
    logger: ['error', 'warn', 'log'],
  });

  app.enableShutdownHooks();

  logger.log('‚úÖ Dedicated Worker started');
  logger.log('üîÑ Processing jobs from: notifications, documents, sync, analytics, cleanup');
  
  // Graceful shutdown
  process.on('SIGTERM', async () => {
    logger.log('‚ö†Ô∏è  SIGTERM received');
    await app.close();
    process.exit(0);
  });

  process.on('SIGINT', async () => {
    logger.log('‚ö†Ô∏è  SIGINT received');
    await app.close();
    process.exit(0);
  });
}

bootstrap();
