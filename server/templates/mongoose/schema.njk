import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
{% set needsMongooseSchema = false %}
{% if relationships and relationships | length > 0 %}{% set needsMongooseSchema = true %}{% endif %}
{% for field in model.fields %}
  {% if 'MongooseSchema' in field.mongooseType %}{% set needsMongooseSchema = true %}{% endif %}
{% endfor %}
import { Document as MongooseDocument{% if needsMongooseSchema %}, Schema as MongooseSchema{% endif %} } from 'mongoose';

export type {{ model.name }}Document = {{ model.name }} & MongooseDocument;

@Schema({% if model.timestamps %}{ timestamps: true }{% endif %})
export class {{ model.name }} {
{% for field in model.fields %}
  @Prop({
    type: {{ field.mongooseType }},
    required: {{ field.required | lower }},
    {% if field.unique %}unique: true,{% endif %}
    {% if field.indexed %}index: true,{% endif %}
    {% if field.ref %}ref: '{{ field.ref }}',{% endif %}
    {% if field.defaultValue !== undefined and field.defaultValue !== null %}default: {% if field.defaultValue === 'now' %}Date.now{% elif field.type === 'string' or field.type === 'enum' %}'{{ field.defaultValue }}'{% else %}{{ field.defaultValue }}{% endif %},{% endif %}
    {% if field.enum %}enum: [{% for enumValue in field.enum %}'{{ enumValue }}'{% if not loop.last %}, {% endif %}{% endfor %}],{% endif %}
  })
  {{ field.name }}!: {{ field.tsType }};

{% endfor %}
}

export const {{ model.name }}Schema = SchemaFactory.createForClass({{ model.name }});

// Compound indexes for common query patterns
{% if model.timestamps %}
// Index for sorting by creation date (most common query pattern)
{{ model.name }}Schema.index({ createdAt: -1 });
{% endif %}

{% set uniqueFields = [] %}
{% for field in model.fields %}
  {% if field.unique %}
    {% set _ = uniqueFields.push(field.name) %}
  {% endif %}
{% endfor %}

{% if uniqueFields.length > 0 and model.timestamps %}
// Compound index for unique field lookups with timestamps
{{ model.name }}Schema.index({ {{ uniqueFields[0] }}: 1, createdAt: -1 });
{% endif %}

{% set textSearchFields = [] %}
{% for field in model.fields %}
  {% if field.type === 'string' and (field.name.includes('name') or field.name.includes('title') or field.name.includes('description')) %}
    {% set _ = textSearchFields.push(field.name) %}
  {% endif %}
{% endfor %}

{% if textSearchFields.length > 0 %}
// Text search index for common search queries
{{ model.name }}Schema.index({ {% for field in textSearchFields %}{{ field }}: 'text'{% if not loop.last %}, {% endif %}{% endfor %} });
{% endif %}

{% if relationships %}
// Relationship indexes
{% for rel in relationships %}
{% if rel.type == 'many-to-one' and rel.sourceModel == model.name %}
{{ model.name }}Schema.index({ {{ rel.fieldName }}: 1 });
{% elif rel.type == 'one-to-many' and rel.targetModel == model.name %}
{{ model.name }}Schema.index({ {{ rel.sourceModel | lower }}Id: 1 });
{% endif %}
{% endfor %}

// Virtual populate for relationships
{% for rel in relationships %}
{% if rel.type == 'one-to-many' and rel.sourceModel == model.name %}
{{ model.name }}Schema.virtual('{{ rel.fieldName }}', {
  ref: '{{ rel.targetModel }}',
  localField: '_id',
  foreignField: '{{ rel.sourceModel | lower }}Id',
  justOne: false,
});
{% elif rel.type == 'one-to-one' and rel.sourceModel == model.name %}
{{ model.name }}Schema.virtual('{{ rel.fieldName }}', {
  ref: '{{ rel.targetModel }}',
  localField: '_id',
  foreignField: '{{ rel.sourceModel | lower }}Id',
  justOne: true,
});
{% endif %}
{% endfor %}

{{ model.name }}Schema.set('toJSON', { virtuals: true });
{{ model.name }}Schema.set('toObject', { virtuals: true });
{% endif %}
