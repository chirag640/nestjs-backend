import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose';

export type {{ model.name }}Document = {{ model.name }} & Document;

@Schema({% if model.timestamps %}{ timestamps: true }{% endif %})
export class {{ model.name }} {
{% for field in model.fields %}
  @Prop({
    type: {{ field.mongooseType }},
    required: {{ field.required | lower }},
    {% if field.unique %}unique: true,{% endif %}
    {% if field.indexed %}index: true,{% endif %}
    {% if field.defaultValue !== undefined and field.defaultValue !== null %}default: {% if field.type === 'string' %}'{{ field.defaultValue | replace("\\", "\\\\") | replace("'", "\\'") }}'{% else %}{{ field.defaultValue }}{% endif %},{% endif %}
    {% if field.enum %}enum: [{% for enumValue in field.enum %}'{{ enumValue | replace("\\", "\\\\") | replace("'", "\\'") }}'{% if not loop.last %}, {% endif %}{% endfor %}],{% endif %}
  })
  {{ field.name }}: {{ field.tsType }};

{% endfor %}
}

export const {{ model.name }}Schema = SchemaFactory.createForClass({{ model.name }});

// Compound indexes for common query patterns
{% if model.timestamps %}
// Index for sorting by creation date (most common query pattern)
{{ model.name }}Schema.index({ createdAt: -1 });
{% endif %}

{% set uniqueFields = [] %}
{% for field in model.fields %}
  {% if field.unique %}
    {% set _ = uniqueFields.push(field.name) %}
  {% endif %}
{% endfor %}

{% if uniqueFields.length > 0 and model.timestamps %}
// Compound index for unique field lookups with timestamps
{{ model.name }}Schema.index({ {{ uniqueFields[0] }}: 1, createdAt: -1 });
{% endif %}
