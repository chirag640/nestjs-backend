import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  HttpCode,
  HttpStatus,
  {% if auth and auth.enabled %}UseGuards,{% endif %}
  Query,
} from '@nestjs/common';
{% if features.rateLimit %}
import { Throttle } from '@nestjs/throttler';
{% endif %}
{% if features.swagger %}
import {
  ApiTags,
  ApiOperation,
  ApiResponse,
  {% if auth and auth.enabled %}ApiBearerAuth,{% endif %}
  ApiParam,
  ApiQuery,
} from '@nestjs/swagger';
{% endif %}
import { {{ model.name }}Service } from './{{ model.fileName }}.service';
import { {{ model.createDtoName }} } from './dto/create-{{ model.fileName }}.dto';
import { {{ model.updateDtoName }} } from './dto/update-{{ model.fileName }}.dto';
import { {{ model.outputDtoName }} } from './dto/{{ model.fileName }}-output.dto';
{% if features.swagger %}
import { ErrorResponseDto } from '../../common/error-response.dto';
{% endif %}
{% if auth and auth.enabled %}
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
{% if auth.rbac and auth.rbac.enabled %}
import { RolesGuard } from '../auth/guards/roles.guard';
import { Roles } from '../auth/decorators/roles.decorator';
{% endif %}
{% endif %}

{% if features.swagger %}
@ApiTags('{{ model.namePlural }}')
{% endif %}
{% if auth and auth.enabled %}
@UseGuards(JwtAuthGuard{% if auth.rbac and auth.rbac.enabled %}, RolesGuard{% endif %})
{% if features.swagger %}
@ApiBearerAuth()
{% endif %}
{% endif %}
@Controller('{{ model.route | replace("/", "") }}')
export class {{ model.name }}Controller {
  constructor(private readonly {{ model.nameCamel }}Service: {{ model.name }}Service) {}

  {% if features.swagger %}
  @ApiOperation({ summary: 'Create a new {{ model.nameCamel }}' })
  @ApiResponse({ status: 201, description: '{{ model.name }} created successfully', type: {{ model.outputDtoName }} })
  @ApiResponse({ 
    status: 400, 
    description: 'Invalid input data - validation failed',
    type: ErrorResponseDto,
    schema: {
      example: {
        statusCode: 400,
        message: ['Field validation error messages'],
        error: 'Bad Request',
        timestamp: '2024-01-01T00:00:00.000Z',
        path: '/{{ model.route | replace("/", "") }}',
      },
    },
  })
  {% if auth and auth.enabled %}
  @ApiResponse({ 
    status: 401, 
    description: 'Unauthorized - invalid or missing authentication token',
    type: ErrorResponseDto,
  })
  {% endif %}
  @ApiResponse({ 
    status: 409, 
    description: 'Conflict - duplicate unique field (e.g., email already exists)',
    type: ErrorResponseDto,
    schema: {
      example: {
        statusCode: 409,
        message: 'Resource already exists',
        error: 'Conflict',
        timestamp: '2024-01-01T00:00:00.000Z',
        path: '/{{ model.route | replace("/", "") }}',
      },
    },
  })
  @ApiResponse({ 
    status: 500, 
    description: 'Internal server error',
    type: ErrorResponseDto,
  })
  {% endif %}
  @Post()
  @HttpCode(HttpStatus.CREATED)
  {% if auth and auth.rbac and auth.rbac.enabled %}
  {% if model.rbacRoles and model.rbacRoles.create %}
  @Roles({% for role in model.rbacRoles.create %}'{{ role }}'{% if not loop.last %}, {% endif %}{% endfor %})
  {% endif %}
  {% endif %}
  {% if features.rateLimit %}
  @Throttle({ default: { limit: 100, ttl: 60000 } }) // 100 requests per minute
  {% endif %}
  create(@Body() dto: {{ model.createDtoName }}): Promise<{{ model.outputDtoName }}> {
    return this.{{ model.nameCamel }}Service.create(dto);
  }

  {% if features.swagger %}
  @ApiOperation({ summary: 'Get all {{ model.namePlural }} with pagination' })
  @ApiQuery({ name: 'page', required: false, type: Number, description: 'Page number (default: 1)' })
  @ApiQuery({ name: 'limit', required: false, type: Number, description: 'Items per page (default: 10, max: 100)' })
  @ApiResponse({ 
    status: 200, 
    description: 'Paginated list of {{ model.namePlural }}',
    schema: {
      type: 'object',
      properties: {
        data: { type: 'array', items: { $ref: '#/components/schemas/{{ model.outputDtoName }}' } },
        meta: {
          type: 'object',
          properties: {
            page: { type: 'number', example: 1 },
            limit: { type: 'number', example: 10 },
            total: { type: 'number', example: 156 },
            totalPages: { type: 'number', example: 16 },
          },
        },
      },
    },
  })
  {% if auth and auth.enabled %}
  @ApiResponse({ 
    status: 401, 
    description: 'Unauthorized - invalid or missing authentication token',
    type: ErrorResponseDto,
  })
  @ApiResponse({ 
    status: 403, 
    description: 'Forbidden - insufficient permissions',
    type: ErrorResponseDto,
  })
  {% endif %}
  @ApiResponse({ 
    status: 500, 
    description: 'Internal server error',
    type: ErrorResponseDto,
  })
  {% endif %}
  @Get()
  {% if features.rateLimit %}
  @Throttle({ default: { limit: 200, ttl: 60000 } }) // 200 requests per minute for read operations
  {% endif %}
  findAll(
    @Query('page') page?: number,
    @Query('limit') limit?: number,
  ) {
    return this.{{ model.nameCamel }}Service.findAll(page, limit);
  }

  {% if features.swagger %}
  @ApiOperation({ summary: 'Get a {{ model.nameCamel }} by ID' })
  @ApiParam({ name: 'id', description: '{{ model.name }} ID', example: '507f1f77bcf86cd799439011' })
  @ApiResponse({ status: 200, description: '{{ model.name }} found', type: {{ model.outputDtoName }} })
  @ApiResponse({ 
    status: 400, 
    description: 'Bad Request - invalid ID format',
    type: ErrorResponseDto,
    schema: {
      example: {
        statusCode: 400,
        message: 'Invalid ObjectId format',
        error: 'Bad Request',
        timestamp: '2024-01-01T00:00:00.000Z',
        path: '/{{ model.route | replace("/", "") }}/invalid-id',
      },
    },
  })
  {% if auth and auth.enabled %}
  @ApiResponse({ 
    status: 401, 
    description: 'Unauthorized - invalid or missing authentication token',
    type: ErrorResponseDto,
  })
  {% endif %}
  @ApiResponse({ 
    status: 404, 
    description: '{{ model.name }} not found',
    type: ErrorResponseDto,
    schema: {
      example: {
        statusCode: 404,
        message: '{{ model.name }} with ID 507f1f77bcf86cd799439011 not found',
        error: 'Not Found',
        timestamp: '2024-01-01T00:00:00.000Z',
        path: '/{{ model.route | replace("/", "") }}/507f1f77bcf86cd799439011',
      },
    },
  })
  @ApiResponse({ 
    status: 500, 
    description: 'Internal server error',
    type: ErrorResponseDto,
  })
  {% endif %}
  @Get(':id')
  {% if features.rateLimit %}
  @Throttle({ default: { limit: 200, ttl: 60000 } }) // 200 requests per minute
  {% endif %}
  findOne(@Param('id') id: string): Promise<{{ model.outputDtoName }}> {
    return this.{{ model.nameCamel }}Service.findOne(id);
  }

  {% if features.swagger %}
  @ApiOperation({ summary: 'Update a {{ model.nameCamel }}' })
  @ApiParam({ name: 'id', description: '{{ model.name }} ID', example: '507f1f77bcf86cd799439011' })
  @ApiResponse({ status: 200, description: '{{ model.name }} updated successfully', type: {{ model.outputDtoName }} })
  @ApiResponse({ 
    status: 400, 
    description: 'Bad Request - invalid input data or ID format',
    type: ErrorResponseDto,
  })
  {% if auth and auth.enabled %}
  @ApiResponse({ 
    status: 401, 
    description: 'Unauthorized - invalid or missing authentication token',
    type: ErrorResponseDto,
  })
  @ApiResponse({ 
    status: 403, 
    description: 'Forbidden - insufficient permissions to update this resource',
    type: ErrorResponseDto,
  })
  {% endif %}
  @ApiResponse({ 
    status: 404, 
    description: '{{ model.name }} not found',
    type: ErrorResponseDto,
  })
  @ApiResponse({ 
    status: 409, 
    description: 'Conflict - duplicate unique field value',
    type: ErrorResponseDto,
  })
  @ApiResponse({ 
    status: 500, 
    description: 'Internal server error',
    type: ErrorResponseDto,
  })
  {% endif %}
  @Patch(':id')
  {% if auth and auth.rbac and auth.rbac.enabled %}
  {% if model.rbacRoles and model.rbacRoles.update %}
  @Roles({% for role in model.rbacRoles.update %}'{{ role }}'{% if not loop.last %}, {% endif %}{% endfor %})
  {% endif %}
  {% endif %}
  {% if features.rateLimit %}
  @Throttle({ default: { limit: 100, ttl: 60000 } }) // 100 requests per minute for updates
  {% endif %}
  update(
    @Param('id') id: string,
    @Body() dto: {{ model.updateDtoName }},
  ): Promise<{{ model.outputDtoName }}> {
    return this.{{ model.nameCamel }}Service.update(id, dto);
  }

  {% if features.swagger %}
  @ApiOperation({ summary: 'Delete a {{ model.nameCamel }}' })
  @ApiParam({ name: 'id', description: '{{ model.name }} ID', example: '507f1f77bcf86cd799439011' })
  @ApiResponse({ status: 204, description: '{{ model.name }} deleted successfully' })
  @ApiResponse({ 
    status: 400, 
    description: 'Bad Request - invalid ID format',
    type: ErrorResponseDto,
  })
  {% if auth and auth.enabled %}
  @ApiResponse({ 
    status: 401, 
    description: 'Unauthorized - invalid or missing authentication token',
    type: ErrorResponseDto,
  })
  @ApiResponse({ 
    status: 403, 
    description: 'Forbidden - insufficient permissions to delete this resource',
    type: ErrorResponseDto,
  })
  {% endif %}
  @ApiResponse({ 
    status: 404, 
    description: '{{ model.name }} not found',
    type: ErrorResponseDto,
  })
  @ApiResponse({ 
    status: 409, 
    description: 'Conflict - resource has dependencies and cannot be deleted',
    type: ErrorResponseDto,
    schema: {
      example: {
        statusCode: 409,
        message: 'Cannot delete {{ model.nameCamel }} - has related records',
        error: 'Conflict',
        timestamp: '2024-01-01T00:00:00.000Z',
        path: '/{{ model.route | replace("/", "") }}/507f1f77bcf86cd799439011',
      },
    },
  })
  @ApiResponse({ 
    status: 500, 
    description: 'Internal server error',
    type: ErrorResponseDto,
  })
  {% endif %}
  @Delete(':id')
  @HttpCode(HttpStatus.NO_CONTENT)
  {% if auth and auth.rbac and auth.rbac.enabled %}
  {% if model.rbacRoles and model.rbacRoles.delete %}
  @Roles({% for role in model.rbacRoles.delete %}'{{ role }}'{% if not loop.last %}, {% endif %}{% endfor %})
  {% endif %}
  {% endif %}
  {% if features.rateLimit %}
  @Throttle({ default: { limit: 50, ttl: 60000 } }) // 50 requests per minute for deletes
  {% endif %}
  remove(@Param('id') id: string): Promise<void> {
    return this.{{ model.nameCamel }}Service.remove(id);
  }

{% if relationships %}
  // Relationship endpoints
{% for rel in relationships %}
{% if rel.type == 'many-to-one' and rel.sourceModel == model.name %}
  {% if features.swagger %}
  @ApiOperation({ summary: 'Get all {{ model.namePlural }} for a specific {{ rel.targetModel }}' })
  @ApiParam({ name: '{{ rel.fieldName }}', description: '{{ rel.targetModel }} ID' })
  @ApiResponse({ status: 200, description: 'List of {{ model.namePlural }}', type: [{{ model.outputDtoName }}] })
  {% endif %}
  @Get('by-{{ rel.fieldName }}/:{{ rel.fieldName }}')
  findBy{{ rel.fieldName | capitalize }}(@Param('{{ rel.fieldName }}') {{ rel.fieldName }}: string) {
    return this.{{ model.nameCamel }}Service.findBy{{ rel.fieldName | capitalize }}({{ rel.fieldName }});
  }

{% elif rel.type == 'one-to-many' and rel.sourceModel == model.name %}
  {% if features.swagger %}
  @ApiOperation({ summary: 'Get all {{ rel.fieldName }} for this {{ model.nameCamel }}' })
  @ApiParam({ name: 'id', description: '{{ model.name }} ID' })
  @ApiResponse({ status: 200, description: 'List of related {{ rel.fieldName }}' })
  {% endif %}
  @Get(':id/{{ rel.fieldName }}')
  get{{ rel.fieldName | capitalize }}(@Param('id') id: string) {
    return this.{{ model.nameCamel }}Service.get{{ rel.fieldName | capitalize }}(id);
  }

{% endif %}
{% endfor %}
{% endif %}
}
