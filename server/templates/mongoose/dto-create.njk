import {
  IsOptional,
{% set validatorSet = [] %}
{% set hasDateFields = false %}
{% for field in model.fields %}
  {% if field.tsType === 'Date' %}{% set hasDateFields = true %}{% endif %}
  {% for validator in field.validators %}
    {% set cleanValidator = validator.split('(')[0].trim() %}
    {% if cleanValidator not in validatorSet and cleanValidator != 'IsOptional' %}
      {% set _ = validatorSet.push(cleanValidator) %}
  {{ cleanValidator }},
    {% endif %}
  {% endfor %}
  {% if field.enhancedValidators %}
    {% for enhancedValidator in field.enhancedValidators %}
      {% set cleanEnhanced = enhancedValidator.split('(')[0].trim() %}
      {% if cleanEnhanced not in validatorSet and cleanEnhanced != 'IsOptional' %}
        {% set _ = validatorSet.push(cleanEnhanced) %}
  {{ cleanEnhanced }},
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
} from 'class-validator';
import { Transform{% if hasDateFields %}, Type{% endif %} } from 'class-transformer';
import { ApiProperty } from '@nestjs/swagger';
import sanitizeHtml from 'sanitize-html';

export class {{ model.createDtoName }} {
{% for field in model.fields %}
  {% if field.apiExample %}
  @ApiProperty({
    description: '{{ field.apiDescription | default(field.name) }}',
    example: {{ field.apiExample | safe }},
    {% if field.required and not field.defaultValue %}required: true,{% else %}required: false,{% endif %}
    {% if field.minLength %}minLength: {{ field.minLength }},{% endif %}
    {% if field.maxLength %}maxLength: {{ field.maxLength }},{% endif %}
    {% if field.min %}minimum: {{ field.min }},{% endif %}
    {% if field.max %}maximum: {{ field.max }},{% endif %}
    {% if field.type === 'array' %}type: 'array',{% endif %}
  })
  {% endif %}
  {% if field.required and not field.defaultValue %}
  {% if field.type === 'string' %}
  @Transform(({ value }) => {
    if (!value) return value;
    const trimmed = value.trim();
    // Sanitize HTML to prevent XSS attacks
    return sanitizeHtml(trimmed, { allowedTags: [], allowedAttributes: {} });
  })
  {% elif field.tsType === 'Date' %}
  @Transform(({ value }) => {
    if (!value) return value;
    // Handle various date formats
    const date = new Date(value);
    if (isNaN(date.getTime())) return value; // Let validator handle invalid dates
    return date.toISOString(); // Normalize to ISO 8601
  })
  {% endif %}
  {% for validator in field.validators %}
  @{{ validator }}
  {% endfor %}
  {% if field.enhancedValidators %}
  {% for enhancedValidator in field.enhancedValidators %}
  @{{ enhancedValidator }}()
  {% endfor %}
  {% endif %}
  {% if field.tsType === 'Date' %}
  @Type(() => Date)
  {% endif %}
  {{ field.name }}!: {{ field.tsType }};
  {% else %}
  @IsOptional()
  @Transform(({ value }) => {
    // Handle string "null" from frontend forms
    if (value === 'null' || value === 'undefined' || value === '') return undefined;
    if (!value) return value;
    {% if field.type === 'string' %}
    const trimmed = value.trim();
    // Sanitize HTML to prevent XSS attacks
    return sanitizeHtml(trimmed, { allowedTags: [], allowedAttributes: {} });
    {% elif field.tsType === 'Date' %}
    // Handle various date formats
    const date = new Date(value);
    if (isNaN(date.getTime())) return value; // Let validator handle invalid dates
    return date.toISOString(); // Normalize to ISO 8601
    {% else %}
    return value;
    {% endif %}
  })
  {% for validator in field.validators %}
  @{{ validator }}
  {% endfor %}
  {% if field.enhancedValidators %}
  {% for enhancedValidator in field.enhancedValidators %}
  @{{ enhancedValidator }}()
  {% endfor %}
  {% endif %}
  {% if field.tsType === 'Date' %}
  @Type(() => Date)
  {% endif %}
  {{ field.name }}?: {{ field.tsType }};
  {% endif %}

{% endfor %}
}
